<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="theme-color" content="#563d7c">
	<title>Archiver</title>
	<link rel="stylesheet" href="css/bootstrap.min.css">
	<link rel="stylesheet" href="css/frontend.css">
	<script src="js/jquery.min.js"></script>
	<script src="js/popper.min.js"></script>
	<script src="js/bootstrap.min.js"></script>
	<script src="js/config-frontend.js"></script>
	<script type="text/javascript">
		var basePathBackend = '';
		var chosenUnencryptedFile = null;
		var chosenDirectory = null;
		var timer;

		$(document).ready(function() {
			var unencryptedFilesElm = $('#unencryptedFiles');
			var directoriesElm = $('#directories');
			var newFileNameSuggestionsElm = $('#newFileNameSuggestions');
			var newFileNameSuggestionsContainerElm = $('#newFileNameSuggestionsContainer');
			var newFileNameElm = $('#newFileName');
			var rootDirectorySelectorElm = $('#rootDirectorySelector');
			var chosenUnencryptedFileElm = $('#chosenUnencryptedFile');
			
			loadQueue();
			chooseSubdirectory('/');

			// binds
			rootDirectorySelectorElm.click(function() {
				chooseSubdirectory('/');
			});
			$('#archive').click(function() {
				$('.alert').hide();
				var newFileName = newFileNameElm.val();
				if ((chosenUnencryptedFile != null) && (chosenDirectory != null) && (newFileName != null)) {
					archive(chosenUnencryptedFile, chosenDirectory, newFileName);
				} else {
					$('#errormessage').show();
				}
			});
			$('#logout').click(function(evt) {
				logout();
				location.href = '/';
			});
			$('#directoryNamePattern').on('input', function() {
				clearTimeout(timer);
				directoriesElm.empty().append('Verzeichnisse werden geladen...');
				timer = setTimeout(function() {
					loadSubdirectories(chosenDirectory, 25, $('#directoryNamePattern').val(), true);
				}, 400);
			});
			$('#suggestedFileNameIncrementYear').click(function(evt) {
				spinDate(1);
			});
			$('#suggestedFileNameDecrementYear').click(function(evt) {
				spinDate(-1);
			});
		

			// --------------------------- functions
			function spinDate(offset) {
				let selectionStart = newFileNameElm.get(0).selectionStart;
				let selectionEnd = newFileNameElm.get(0).selectionEnd;
				let oldFileName = newFileNameElm.val();
				let selectedText = oldFileName.substr(selectionStart, selectionEnd - selectionStart);
				let selectedDate = new Date(Date.parse(selectedText));
				if (selectedDate) {
					let newDate = new Date(selectedDate);
					let replaceBy = selectedText;
					switch (selectedText.length) {
						case 4: newDate.setFullYear(selectedDate.getFullYear() + offset); replaceBy = newDate.getFullYear(); break;
						case 7: newDate.setMonth(selectedDate.getMonth() + offset); replaceBy = newDate.getFullYear() + '-' + twoDigits(newDate.getMonth() + 1); break;
						case 10: newDate.setDate(selectedDate.getDate() + offset); replaceBy = newDate.getFullYear() + '-' + twoDigits(newDate.getMonth() + 1) + '-' + twoDigits(newDate.getDate()); break;
					}
					newFileNameElm.val(oldFileName.substr(0, selectionStart) + replaceBy + oldFileName.substr(selectionEnd));
				}
			}
			
			function loadQueue() {
				$.ajax({
					type: 'GET',
					url: basePathBackend + '/queue',
					success: function(fileNames){
						unencryptedFilesElm.empty();
						
						if (fileNames.length == 0) {
							unencryptedFilesElm.text('keine vorhanden');
						} else {
							$.each(fileNames, function(i, fileName) {
								var elm = $('<a href="javascript:void(0)" class="list-group-item list-group-item-action" />')
									.append(fileName);
									
								elm.click(function() {
									chooseFile(fileName);
								});
								
								unencryptedFilesElm.append(elm);
							});
						}
					}
				});
			}
			
			function chooseFile(fileName) {
				chosenUnencryptedFile = fileName;
				
				if (fileName != null) {
					chosenUnencryptedFileElm.text(fileName);
					suggestSearchPatternAndFilename(fileName);
				} else {
					chosenUnencryptedFileElm.empty();
					newFileNameElm.val('');
				}
			}
			
			function suggestSearchPatternAndFilename(fileName) {
				
				// get suggestions for folder search pattern and filename
				let suggestions = guessSearchPatternAndFilenameSuggestion(fileName);

				if (suggestions) {
				
					// auto-populate search pattern
					if (suggestions.folder) {
						$('#directoryNamePattern')
							.val(suggestions.folder)
							.trigger('input');
					}
					
					// auto-populate filename
					suggestFilename(suggestions);
				}	else {
					newFileNameElm.val(fileName);
				}
			}
			
			function suggestFilename(suggestions) {
				
				// auto-populate filename
				if (suggestions && suggestions.filename) {
					newFileNameElm.val(suggestions.filename);

					$('#filenamesuggestionchangedmessage').show().delay(60000).slideUp();
					
					
					
					// TODO: 
					// auto-select date
					// if (replaceBy) {
					// 	newFileNameElm.focus();
					// // 	newFileNameElm.get(0).selectionStart = suggestedName.indexOf(replaceBy);
					// 	newFileNameElm.get(0).selectionEnd = newFileNameElm.get(0).selectionStart + replaceBy.length;
					// }
					//
					// support +x, -x in now:variablen
				}
			}

			function guessSearchPatternAndFilenameSuggestion(unencryptedFileName) {
				var matchingFileNamePattern;
				var matches;
				
				if (typeof fileNamePatternToSuggestions !== 'undefined') {
				
					// iterate over all defined search patterns and find matches
					if (Object.keys(fileNamePatternToSuggestions).some(function(regexToTest){
						matches = new RegExp(regexToTest, 'gm').exec(unencryptedFileName);
						if (matches && matches.length > 0) {
							matchingFileNamePattern = regexToTest;
							return true;
						} else {
							return false;
						}
					})) {
						var result = fileNamePatternToSuggestions[matchingFileNamePattern];
						
						// replace variables in filename and folder
						if (matches) {
						
							// get unparsed suggestions
							var filenameSuggestion = fileNamePatternToSuggestions[matchingFileNamePattern].filename ? fileNamePatternToSuggestions[matchingFileNamePattern].filename : '';
							var folderSuggestion = fileNamePatternToSuggestions[matchingFileNamePattern].folder ? fileNamePatternToSuggestions[matchingFileNamePattern].folder : '';

							// inject now into named groups
							var now = new Date();
							var replacePatternAndValues = {...(matches.groups ? matches.groups : {}), ...{'now:year': now.getFullYear(), 'now:month': twoDigits(now.getMonth() + 1), 'now:date': twoDigits(now.getDate())}};

							Object.keys(replacePatternAndValues).forEach(pattern => {

								// ...in filename
								filenameSuggestion = filenameSuggestion.replaceAll('<' + pattern + '>', replacePatternAndValues[pattern]);

								// ...in search pattern
								folderSuggestion = folderSuggestion.replaceAll('<' + pattern + '>', replacePatternAndValues[pattern]);
							});
							
							result.filename = filenameSuggestion;
							result.folder = folderSuggestion;
						}
						
						return result
					} else {
						return false;
					}
				}
			}
			
			function chooseSubdirectory(directoryName) {
				chosenDirectory = directoryName;
				$('#chosenDirectory').text(directoryName.startsWith('/') ? directoryName : '/' + directoryName);
				$('#directoryNamePattern').val('');
				loadSubdirectories(directoryName, 1, null, false);
				loadExistingFileNamesAsSuggestions(directoryName);
			}
			
			function loadSubdirectories(parentDirectoryName, depth, directoryNamePattern, autoOpenFirstSubdirectory) {
				$.ajax({
					type: 'GET',
					url: basePathBackend + '/archive/' + encodeURIComponent(parentDirectoryName) + '/directory?depth=' + encodeURIComponent(depth) + '&' + (directoryNamePattern ? 'pattern=' + encodeURIComponent(directoryNamePattern) : ''),
					success: function(fullDirectoryNames){
						directoriesElm.empty();
						var fullDirectoryNamesGroupedByShortDirectoryNames = {};
						
						// make sure that directory captions are unambiguous
						$.each(fullDirectoryNames, function(i, fullDirectoryName) {
							var shortDirectoryName = fullDirectoryName.split('/').pop();
							
							if (!fullDirectoryNamesGroupedByShortDirectoryNames[shortDirectoryName]) {
								fullDirectoryNamesGroupedByShortDirectoryNames[shortDirectoryName] = new Array();
							} 
							
							fullDirectoryNamesGroupedByShortDirectoryNames[shortDirectoryName].push(fullDirectoryName);
						});
						
						// add directories to ui
						$.each(fullDirectoryNamesGroupedByShortDirectoryNames, function(shortDirectoryName, fullDirectoryNamesGroupedByShortDirectoryName) {
							var fullNameAsCaption = (fullDirectoryNamesGroupedByShortDirectoryName.length > 1);
							
							$.each(fullDirectoryNamesGroupedByShortDirectoryName, function(j, fullDirectoryName) {
								var elm = $('<a href="javascript:void(0)" class="list-group-item list-group-item-action" />')
									.append(fullNameAsCaption ? shortDirectoryName + " <small>(in " + fullDirectoryName.replace(shortDirectoryName, "") + ")</small>" : shortDirectoryName);
								
								elm.click(function() {
									chooseSubdirectory(fullDirectoryName);
									return false;
								});
								
								directoriesElm.append(elm);
							});			
						});
						
						// auto-click directory
						if (autoOpenFirstSubdirectory && (fullDirectoryNames.length == 1)) {
							directoriesElm.children(0).trigger('click');
							
							$('#directoryautopickedmessage').show().delay(5000).slideUp();
						}
					}
				});
			}
			
			function loadExistingFileNamesAsSuggestions(directoryName) {
				$.ajax({
					type: 'GET',
					url: basePathBackend + '/archive/' + encodeURIComponent(directoryName) + '/file',
					success: function(fileNames){
						newFileNameSuggestionsElm.empty();
						
						if (fileNames.length > 0) {
							$.each(fileNames, function(i, fileName) {
								var caption = (fileName.length > 40) ? fileName.substr(0, 20) + '...' +  fileName.substr(fileName.length - 20) : fileName;
								var elm = $('<a class="dropdown-item" />')
									.append(caption);
								
								elm.click(function() {
									var fileNameWithoutExtension = (fileName.substr(fileName.length - 4) == '.gpg') ? fileName.substr(0, fileName.length - 4) : fileName;
									suggestSearchPatternAndFilename(fileNameWithoutExtension);
								});
								
								newFileNameSuggestionsElm.append(elm);
							});
							newFileNameSuggestionsContainerElm.show();
						} else {
							newFileNameSuggestionsContainerElm.hide();
						}
					}
				});
			}
			
			function twoDigits(i) {
				return ((parseInt(i) < 10) ? "0" : "") + i;
			}
			
			function archive(fileName, destinationDirectory, newFileName) {
				$.ajax({
					type: 'PUT',
					url: basePathBackend + '/queue/' + encodeURIComponent(fileName) + '?destination=' + encodeURIComponent(destinationDirectory) + '&newFileName=' + encodeURIComponent(newFileName),
					success: function(){
						$('#successmessage').show();
						loadQueue();
						chooseFile(null);
					}, 
					error: function() {
						$('#errormessage').show();
					}
				});
			}
			
			function logout() {
				document.cookie = "token=;expires=Thu, 01 Jan 1970 00:00:00 UTC;domain=sintra;path=/";
			}
			
		});
		
	</script>
</head>
<body>
	<nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top">
		<a class="navbar-brand" href="/">Archiver</a>
		
		<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
			<span class="navbar-toggler-icon"></span>
		</button>
		
		<div class="collapse navbar-collapse" id="navbarSupportedContent">
			<ul class="navbar-nav mr-auto">
				<li class="nav-item active">
					<a class="nav-link" href="#" id="logout">Abmelden</a>
				</li>
			</ul>
		</div>
	</nav>

	<main role="main" class="container">
		<div class="alert alert-success" role="alert" id="successmessage" style="display:none">
			Datei erfolgreich archiviert!
		</div>

		<div class="alert alert-danger" role="alert" id="errormessage" style="display:none">
			Fehler aufgetreten!
		</div>

		<strong>Zu verschlüsselnde Datei</strong>
		<p id="chosenUnencryptedFile" class="lead">

		</p>
		
		<div class="list-group" id="unencryptedFiles">
		</div>

		<div class="ml-1">&nbsp;</div>
		
		<p>
			<strong>Zielverzeichnis</strong>
		</p>
		<div class="alert alert-info" role="alert" id="directoryautopickedmessage" style="display:none">
			Verzeichnis automatisch gewählt!
		</div>

		<p id="chosenDirectory" class="lead">

		</p>

		<form>
			<div class="input-group mb-3">
				<input type="text" class="form-control" id="directoryNamePattern" placeholder="Tippen, um Verzeichnisse zu filtern..." />
			</div>
		</form>
		<div class="list-group">
			<a href="#" class="list-group-item list-group-item-action" id="rootDirectorySelector">&#47;</a>
			<div id="directories"></div>
		</div>

		<div class="ml-1">&nbsp;</div>

		<p>
			<strong>Dateiname</strong>
		</p>
		<div class="alert alert-info" role="alert" id="filenamesuggestionchangedmessage" style="display:none">
			Dateiname durch Vorschlag aktualisiert! <a href="javascript:void(0)" id="suggestedFileNameIncrementYear">&uarr;</a> / <a href="javascript:void(0)" id="suggestedFileNameDecrementYear">&darr;</a>
		</div>
		<form>
			<div class="input-group mb-3">
				<div class="input-group-prepend" id="newFileNameSuggestionsContainer">
					<button class="btn btn-outline-secondary dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"></button>
					<div class="dropdown-menu" id="newFileNameSuggestions">
					</div>
				</div>
				<input type="text" class="form-control" id="newFileName" placeholder="Neuer Dateiname" />
				<div class="input-group-append">
					<span class="input-group-text">.gpg</span>
				</div>
			</div>

		</form>
	
		<a class="btn btn-primary" href="#" role="button" id="archive">Archivieren</a>
		
		<div class="ml-1">&nbsp;</div>
	</main><!-- /.container -->
</body>
</html>