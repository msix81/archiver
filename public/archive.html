<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="theme-color" content="#563d7c">
	<title>Archiver</title>
	<link rel="stylesheet" href="css/bootstrap.min.css">
	<link rel="stylesheet" href="css/frontend.css">
	<script src="js/jquery.min.js"></script>
	<script src="js/popper.min.js"></script>
	<script src="js/bootstrap.min.js"></script>
	<script src="js/config-frontend.js"></script>
	<script type="text/javascript">
		var basePathBackend = '';
		var chosenUnencryptedFile = null;
		var chosenDirectory = null;
		var timer;

		$(document).ready(function() {
			var unencryptedFilesElm = $('#unencryptedFiles');
			var directoriesElm = $('#directories');
			var directoryNamePatternElm = $('#directoryNamePattern');
			var newFileNameSuggestionsElm = $('#newFileNameSuggestions');
			var newFileNameSuggestionsLinkElm = $('#newFileNameSuggestionsLink');
			var newFileNameElm = $('#newFileName');
			var rootDirectorySelectorElm = $('#rootDirectorySelector');
			var chosenUnencryptedFileElm = $('#chosenUnencryptedFile');
			
			loadQueue();
			chooseSubdirectory('/');

			// binds
			rootDirectorySelectorElm.click(function() {
				chooseSubdirectory('/');
			});
			$('#archive').click(function() {
				$('.alert').hide();
				var newFileName = newFileNameElm.val();
				if ((chosenUnencryptedFile != null) && (chosenDirectory != null) && (newFileName != null)) {
					archive(chosenUnencryptedFile, chosenDirectory, newFileName);
				} else {
					$('#errormessage').show();
				}
			});
			$('#logout').click(function(evt) {
				logout();
				location.href = '/';
			});
			directoryNamePatternElm.on('input', function() {
				clearTimeout(timer);
				directoriesElm.empty().append('Verzeichnisse werden geladen...');
				timer = setTimeout(function() {
					loadSubdirectories(chosenDirectory, 25, directoryNamePatternElm.val(), true);
				}, 400);
			});
			$('#suggestedFileNameDateInc').click(function(evt) {
				spinDate(1);
			});
			$('#suggestedFileNameDateDec').click(function(evt) {
				spinDate(-1);
			});
			newFileNameSuggestionsLinkElm.click(function(evt) {
				newFileNameSuggestionsElm.slideToggle();
			});
			
			
		

			// --------------------------- functions
			function spinDate(offset) {
				let selectionStart = newFileNameElm.get(0).selectionStart;
				let selectionEnd = newFileNameElm.get(0).selectionEnd;
				let oldFileName = newFileNameElm.val();
				let selectedText = oldFileName.substr(selectionStart, selectionEnd - selectionStart);
				let selectedDate = new Date(Date.parse(selectedText));
				if (selectedDate) {
					let newDate = new Date(selectedDate);
					let replaceBy = selectedText;
					switch (selectedText.length) {
						case 4: newDate.setFullYear(selectedDate.getFullYear() + offset); replaceBy = newDate.getFullYear(); break;
						case 7: newDate.setMonth(selectedDate.getMonth() + offset); replaceBy = newDate.getFullYear() + '-' + twoDigits(newDate.getMonth() + 1); break;
						case 10: newDate.setDate(selectedDate.getDate() + offset); replaceBy = newDate.getFullYear() + '-' + twoDigits(newDate.getMonth() + 1) + '-' + twoDigits(newDate.getDate()); break;
					}
					newFileNameElm.val(oldFileName.substr(0, selectionStart) + replaceBy + oldFileName.substr(selectionEnd));
					autoSelectDate(newFileNameElm);
				}
			}
			
			function loadQueue() {
				$.ajax({
					type: 'GET',
					url: basePathBackend + '/queue',
					success: function(fileNames){
						unencryptedFilesElm.empty();
						
						if (fileNames.length == 0) {
							unencryptedFilesElm.text('keine vorhanden');
						} else {
							$.each(fileNames, function(i, fileName) {
								var elm = $('<a href="javascript:void(0)" class="list-group-item list-group-item-action" />')
									.append(fileName);
									
								elm.click(function() {
									chooseFile(fileName);
								});
								
								unencryptedFilesElm.append(elm);
							});
						}
					}
				});
			}
			
			function chooseFile(fileName) {
				chosenUnencryptedFile = fileName;
				
				if (fileName != null) {
					chosenUnencryptedFileElm.text(fileName);
					suggestSearchPatternAndFilename(fileName);
				} else {
					chosenUnencryptedFileElm.empty();
					newFileNameElm.val('');
				}
			}
			
			function suggestSearchPatternAndFilename(fileName) {
				
				// get suggestions for folder search pattern and filename
				let suggestions = guessSearchPatternAndFilenameSuggestion(fileName);

				if (suggestions) {
				
					// auto-populate search pattern
					if (suggestions.folder) {
						directoryNamePatternElm
							.val(suggestions.folder)
							.trigger('input');
							
						makeGlow(directoryNamePatternElm);
					}
					
					// auto-populate filename
					if (suggestions.filename) {
						newFileNameElm.val(suggestions.filename);
						
						// auto-select date in suggestion
						autoSelectDate(newFileNameElm);
						
						makeGlow(newFileNameElm);
					}
				}	else {
					newFileNameElm.val(fileName);
					$('#suggestedFileNameDateSpin').hide();
				}
			}
			
			function autoSelectDate(elm) {
				if (re = new RegExp('(?<full>2[0-9]{3}(\-(?<mm>0[1-9]|1[0-9])){0,1}(\-(?<dd>0[1-9]|1[0-9]|2[0-9]|3[0-1])){0,1})', 'gm').exec(elm.val())) {
					$('#suggestedFileNameDateSpin').show();
					elm.focus();
					elm.get(0).selectionStart = re.index;
					elm.get(0).selectionEnd = re.index + re.groups.full.length;
				} else {
					$('#suggestedFileNameDateSpin').hide();
				};
			}

			function guessSearchPatternAndFilenameSuggestion(unencryptedFileName) {
				var matches = false;

				if (typeof fileNamePatternToSuggestions !== 'undefined') {
				
					// find first matching search pattern
					var matchingFileNamePattern = Object.keys(fileNamePatternToSuggestions).find(function(regexToTest) {matches = new RegExp(regexToTest, 'gm').exec(unencryptedFileName); return matches && matches.length > 0});
					
					if (matchingFileNamePattern){
						var result = {...fileNamePatternToSuggestions[matchingFileNamePattern]};
	
						// get unparsed suggestions
						var filenameSuggestion = fileNamePatternToSuggestions[matchingFileNamePattern].filename ? fileNamePatternToSuggestions[matchingFileNamePattern].filename : '';
						var folderSuggestion = fileNamePatternToSuggestions[matchingFileNamePattern].folder ? fileNamePatternToSuggestions[matchingFileNamePattern].folder : '';

						// inject now into named groups
						var now = new Date();
						var replacePatternAndValues = {...(matches.groups ? matches.groups : {}), ...{'now:year': now.getFullYear(), 'now:month': twoDigits(now.getMonth() + 1), 'now:date': twoDigits(now.getDate())}};

						Object.keys(replacePatternAndValues).forEach(pattern => {

							// ...in filename
							filenameSuggestion = filenameSuggestion.replaceAll('<' + pattern + '>', replacePatternAndValues[pattern]);

							// ...in search pattern
							folderSuggestion = folderSuggestion.replaceAll('<' + pattern + '>', replacePatternAndValues[pattern]);
						});
						
						result.filename = filenameSuggestion;
						result.folder = folderSuggestion;

						return result;
					}
				}
				return false;
			}
			
			function chooseSubdirectory(directoryName) {
				chosenDirectory = directoryName;
				$('#chosenDirectory').text(directoryName.startsWith('/') ? directoryName : '/' + directoryName);
				directoryNamePatternElm.val('');
				loadSubdirectories(directoryName, 1, null, false);
				loadExistingFileNamesAsSuggestions(directoryName);
			}
			
			function loadSubdirectories(parentDirectoryName, depth, directoryNamePattern, autoOpenFirstSubdirectory) {
				$.ajax({
					type: 'GET',
					url: basePathBackend + '/archive/' + encodeURIComponent(parentDirectoryName) + '/directory?depth=' + encodeURIComponent(depth) + '&' + (directoryNamePattern ? 'pattern=' + encodeURIComponent(directoryNamePattern) : ''),
					success: function(fullDirectoryNames){
						directoriesElm.empty();
						var fullDirectoryNamesGroupedByShortDirectoryNames = {};
						
						// make sure that directory captions are unambiguous
						$.each(fullDirectoryNames, function(i, fullDirectoryName) {
							var shortDirectoryName = fullDirectoryName.split('/').pop();
							
							if (!fullDirectoryNamesGroupedByShortDirectoryNames[shortDirectoryName]) {
								fullDirectoryNamesGroupedByShortDirectoryNames[shortDirectoryName] = new Array();
							} 
							
							fullDirectoryNamesGroupedByShortDirectoryNames[shortDirectoryName].push(fullDirectoryName);
						});
						
						// add directories to ui
						$.each(fullDirectoryNamesGroupedByShortDirectoryNames, function(shortDirectoryName, fullDirectoryNamesGroupedByShortDirectoryName) {
							var fullNameAsCaption = (fullDirectoryNamesGroupedByShortDirectoryName.length > 1);
							
							$.each(fullDirectoryNamesGroupedByShortDirectoryName, function(j, fullDirectoryName) {
								var elm = $('<a href="javascript:void(0)" class="list-group-item list-group-item-action" />')
									.append(fullNameAsCaption ? shortDirectoryName + " <small>(in " + fullDirectoryName.replace(shortDirectoryName, "") + ")</small>" : shortDirectoryName);
								
								elm.click(function() {
									chooseSubdirectory(fullDirectoryName);
									return false;
								});
								
								directoriesElm.append(elm);
							});			
						});
						
						// auto-click directory
						if (autoOpenFirstSubdirectory && (fullDirectoryNames.length == 1)) {
							directoriesElm.children(0).trigger('click');
							
							makeGlow($('#chosenDirectory'));
						}
					}
				});
			}
			
			function makeGlow(elm) {
				elm.addClass('glowing');
				window.setTimeout(function() { elm.removeClass('glowing'); }, 4000);
			}
			
			function loadExistingFileNamesAsSuggestions(directoryName) {
				newFileNameSuggestionsElm.hide();
				newFileNameSuggestionsLinkElm.hide();
				
				$.ajax({
					type: 'GET',
					url: basePathBackend + '/archive/' + encodeURIComponent(directoryName) + '/file',
					success: function(fileNames){
						newFileNameSuggestionsElm.empty();
						
						if (fileNames.length > 0) {
							$.each(fileNames, function(i, fileName) {
								var caption = '&#9657; <small>' + ((fileName.length > 40) ? fileName.substr(0, 20) + '...' +  fileName.substr(fileName.length - 20) : fileName) + '</small>';
								var elm = $('<a href="javascript:void(0)" class="list-group-item list-group-item-action" />')
									.append(caption);
								
								elm.click(function() {
									var fileNameWithoutExtension = (fileName.substr(fileName.length - 4) == '.gpg') ? fileName.substr(0, fileName.length - 4) : fileName;
									suggestSearchPatternAndFilename(fileNameWithoutExtension);
									newFileNameSuggestionsElm.slideUp();
								});
								
								newFileNameSuggestionsElm.append(elm);
							});
							newFileNameSuggestionsLinkElm.show();
						} else {
							newFileNameSuggestionsLinkElm.hide();
						}
					}
				});
			}
			
			function twoDigits(i) {
				return ((parseInt(i) < 10) ? "0" : "") + i;
			}
			
			function archive(fileName, destinationDirectory, newFileName) {
				$.ajax({
					type: 'PUT',
					url: basePathBackend + '/queue/' + encodeURIComponent(fileName) + '?destination=' + encodeURIComponent(destinationDirectory) + '&newFileName=' + encodeURIComponent(newFileName),
					success: function(){
						$('#successmessage').show();
						loadQueue();
						chooseFile(null);
					}, 
					error: function() {
						$('#errormessage').show();
					}
				});
			}
			
			function logout() {
				document.cookie = "token=;expires=Thu, 01 Jan 1970 00:00:00 UTC;domain=sintra;path=/";
			}
			
		});
		
	</script>
</head>
<body>
	<nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top">
		<a class="navbar-brand" href="/">Archiver</a>
		
		<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
			<span class="navbar-toggler-icon"></span>
		</button>
		
		<div class="collapse navbar-collapse" id="navbarSupportedContent">
			<ul class="navbar-nav mr-auto">
				<li class="nav-item active">
					<a class="nav-link" href="#" id="logout">Abmelden</a>
				</li>
			</ul>
		</div>
	</nav>

	<main role="main" class="container">
		<div class="alert alert-success" role="alert" id="successmessage" style="display:none">
			Datei erfolgreich archiviert!
		</div>

		<div class="alert alert-danger" role="alert" id="errormessage" style="display:none">
			Fehler aufgetreten!
		</div>

		<strong>Zu verschlüsselnde Datei</strong>
		<p id="chosenUnencryptedFile" class="lead">

		</p>
		
		<div class="list-group" id="unencryptedFiles">
		</div>

		<div class="ml-1">&nbsp;</div>
		
		<p>
			<strong>Zielverzeichnis</strong>
		</p>
		<p id="chosenDirectory" class="lead glowable">

		</p>

		<form>
			<div class="input-group mb-3">
				<input type="text" class="form-control glowable" id="directoryNamePattern" placeholder="Tippen, um Verzeichnisse zu filtern..." />
			</div>
		</form>
		<div class="list-group">
			<a href="#" class="list-group-item list-group-item-action" id="rootDirectorySelector">&#47;</a>
			<div id="directories"></div>
		</div>

		<div class="ml-1">&nbsp;</div>

		<p>
			<strong>Dateiname</strong> <small><a href="javascript:void(0);" id ="newFileNameSuggestionsLink">Existierende als Vorlage &#9660;</a></small>
		</p>
		
		<div class="list-group" id="newFileNameSuggestions">
			
		</div>

		<form>
			<div class="input-group mb-3">
				<div class="input-group-prepend" id="suggestedFileNameDateSpin" style="display:none">
					<span class="input-group-text">&#x1F4C5; &nbsp;
					<a href="javascript:void(0);" id="suggestedFileNameDateInc">&uarr;</a>&nbsp;
					<a href="javascript:void(0);" id="suggestedFileNameDateDec">&darr;</a>
				</div>
				<input type="text" class="form-control glowable" id="newFileName" placeholder="Neuer Dateiname" />
			</div>

		</form>
	
		<a class="btn btn-primary" href="#" role="button" id="archive">Archivieren</a>
		
		<div class="ml-1">&nbsp;</div>
	</main><!-- /.container -->
</body>
</html>