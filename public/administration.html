<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="theme-color" content="#563d7c">
	<title>Archiver</title>
	<link rel="stylesheet" href="css/bootstrap.min.css">
	<link rel="stylesheet" href="css/frontend.css">
	<script src="js/jquery.min.js"></script>
	<script src="js/bootstrap.min.js"></script>
	<script src="js/commons.js"></script>
	<script type="text/javascript">
		$(document).ready(function() {
			var suggestionsListElm = $('#suggestionsList');
			var suggestionNameElm = $('#suggestionName');
			var suggestionExampleElm = $('#suggestionExample');
			var suggestionPatternElm = $('#suggestionPattern');
			var suggestionFilenameElm = $('#suggestionFilename');
			var suggestionFoldernameElm = $('#suggestionFoldername');
			var suggestionIdElm = $('#suggestionId');
			var suggestionOrderElm = $('#suggestionOrder');
			var saveSuggestionElm = $('#saveSuggestion');
			var removeSuggestionElm = $('#removeSuggestion');
			var upgradeSuggestionElm = $('#upgradeSuggestion');
			var downgradeSuggestionElm = $('#downgradeSuggestion');
			var exportSuggestionsElm = $('#exportSuggestions');
			var importSuggestionsElm = $('#importSuggestions');
			var importSuggestionsFileElm = $('#importSuggestionsFile');
			var suggestionEditFieldsElm = $('#suggestionEditFields');
			
			

			// --------------------------- onload functionality
			loadConfig(function() {renderSuggestions()});

			// binds
			$('#renewCache').click(function(evt) {
				$.ajax({
					type: 'POST',
					url: basePathBackend + '/archive/update-directory-cache?depth=25',
					success: function(){
						$('#successmessage').show().delay(4000).slideUp(400, function() {window.location.reload()});
					}
				});
			});
			saveSuggestionElm.click(function(evt) {
			
				// update locally
				var currentSuggestionIndex = suggestions.findIndex(function(suggestion) {return suggestion.id == suggestionIdElm.val()});
				suggestions[currentSuggestionIndex].name = suggestionNameElm.val();
				suggestions[currentSuggestionIndex].pattern = suggestionPatternElm.val();
				suggestions[currentSuggestionIndex].example = suggestionExampleElm.val();
				suggestions[currentSuggestionIndex].filename = suggestionFilenameElm.val();
				suggestions[currentSuggestionIndex].foldername = suggestionFoldernameElm.val();
				
				renderSuggestions();
				
				saveSuggestions();
			});
			removeSuggestionElm.click(function(evt) {
			
				// update locally, then render
				var currentSuggestionIndex = suggestions.findIndex(function(suggestion) {return suggestion.id == suggestionIdElm.val()});
				suggestions.splice(currentSuggestionIndex, 1);
				
				renderSuggestions();
				
				saveSuggestions();
			});
			$('#addSuggestion').click(function(evt) {
				var newSuggestionId = Date.now();
				
				// update locally, then render
				suggestions.push({
					id: newSuggestionId,
					name: "+++ Neuer Eintrag +++",
					pattern: null,
					example: null,
					filename: null,
					foldername: null,
					order: suggestions.length + 1
				});
				
				renderSuggestions();
				
				$('#suggestion-id-' + newSuggestionId).trigger('click');
			});
			upgradeSuggestionElm.click(function(evt) {
				
				// update locally, then render			
				switchSuggestionOrders(-1);
				
				renderSuggestions();
				
				saveSuggestions();
			});
			downgradeSuggestionElm.click(function(evt) {
				
				// update locally, then render
				switchSuggestionOrders(1);
				
				renderSuggestions();
				
				saveSuggestions();
			});
			exportSuggestionsElm.click(function(evt) {
				window.location.href = basePathBackend + 'config/suggestions?download';
			});
			importSuggestionsElm.click(function(evt) {
				$('#importSuggestionsFile').click();
			});
			importSuggestionsFileElm.on('change', function() {
				var file = importSuggestionsFileElm[0].files[0];
				if (file) {
					var reader = new FileReader();
					reader.readAsText(file, "UTF-8");
					reader.onload = function (evt) {
					
						try {
							suggestions = JSON.parse(evt.target.result);
							
							renderSuggestions();
							
							saveSuggestions();
						} catch (err) {
							console.error("No valid JSON input");
							console.error(err);
							$('#errormessage').show();
						}
					}
					reader.onerror = function (evt) {
						$('#errormessage').show();
					}
				}
			});
			
			// --------------------------- functions
			function switchSuggestionOrders(deltaToSwitchWith) {
				var currentSuggestionIndex = suggestions.findIndex(function(suggestion) {return suggestion.id == suggestionIdElm.val()});
				suggestionIndexB = currentSuggestionIndex + deltaToSwitchWith;

				// switch order of current suggestion and the one above or below
				var bSuggestionOldOrder = suggestions[suggestionIndexB].order;
				suggestions[suggestionIndexB].order = suggestions[currentSuggestionIndex].order;
				suggestions[currentSuggestionIndex].order = bSuggestionOldOrder;
			}
			
			function saveSuggestions() {
				
				// send to backend
				$.ajax({
					type: 'PUT',
					url: basePathBackend + '/config/suggestions',
					data: JSON.stringify(suggestions),
					success: function(){
						$('#suggestionsForm input').val('');
						$('#successmessage').show().delay(4000).slideUp();
					}
				});
			}
			
			function renderSuggestions() {
				suggestionsListElm.empty();
				suggestionEditFieldsElm.hide();
				
				$.each(suggestions.sort((a,b) => (a.order > b.order) ? 1 : ((b.order > a.order) ? -1 : 0)), function(index, suggestion) {
					var elm = $('<a href="javascript:void(0)" class="list-group-item list-group-item-action" id="suggestion-id-' + suggestion.id + '" />')
						.append(suggestion.name);
						
					elm.click(function() {
						suggestionsListElm.children().removeClass('active');
						elm.addClass('active');

						try {
							suggestionIdElm.data('index', index);
							suggestionIdElm.val(suggestion.id);
							suggestionOrderElm.val(suggestion.order);
							suggestionNameElm.val(suggestion.name);
							suggestionExampleElm.val(suggestion.example);
							suggestionPatternElm.val(suggestion.pattern);
							suggestionFilenameElm.val(suggestion.filename);
							suggestionFoldernameElm.val(suggestion.foldername);
						} catch (err) {
							throw new Error('no valid suggestion format');
						}
						
						if (suggestionIdElm.data('index') < suggestions.length - 1) {
							downgradeSuggestionElm.show();
						} else {
							downgradeSuggestionElm.hide();
						}
						if (suggestionIdElm.data('index') > 0) {
							upgradeSuggestionElm.show();
						} else {
							upgradeSuggestionElm.hide();
						}
						suggestionEditFieldsElm.show();
						
						suggestionNameElm.select();
					});
					
					suggestionsListElm.append(elm);
				});
			}
			
		});
		
	</script>
</head>
<body>
	<nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top">
		<a class="navbar-brand" href="/">Archiver</a>
		
		<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
			<span class="navbar-toggler-icon"></span>
		</button>
		
		<div class="collapse navbar-collapse" id="navbarSupportedContent">
			<ul class="navbar-nav mr-auto">
				<li class="nav-item">
					<a class="nav-link" href="archive.html">Archive</a>
				</li>
				<li class="nav-item">
					<a class="nav-link" href="#" id="logout">Logout</a>
				</li>
			</ul>
		</div>
	</nav>

	<main role="main" class="container">
		<div class="alert alert-success" role="alert" id="successmessage" style="display:none">
			Configuration updated successfully!
		</div>

		<div class="alert alert-danger" role="alert" id="errormessage" style="display:none">
			Error occurred!
		</div>

		<h5>
			File and folder suggestions
		</h5>
		<form id="suggestionsForm">
			<div class="list-group" id="suggestionsList">
			</div>
			
			<div class="ml-1">&nbsp;</div>
			
			<div id="suggestionEditFields" style="display: none">
				<input type="hidden" id="suggestionId" />
				<input type="hidden" id="suggestionOrder" />
				<div class="input-group mb-3">
					<div class="input-group-prepend">
						<span class="input-group-text">Name:</span>
					</div>
					<input type="text" class="form-control glowable" id="suggestionName" placeholder="E.g. 'Insurance bill'" />
				</div>
				<div class="input-group mb-3">
					<div class="input-group-prepend">
						<span class="input-group-text">Example:</span>
					</div>
					<input type="text" class="form-control glowable" id="suggestionExample" placeholder="Input file name example, e.g. 'bill-customer-123-2023-01.01.pdf'" />
				</div>
				<div class="input-group mb-3">
					<div class="input-group-prepend">
						<span class="input-group-text">Pattern:</span>
					</div>
					<input type="text" class="form-control glowable" id="suggestionPattern" placeholder="Regular expression to identify the input file" />
				</div>
				<div class="input-group mb-3">
					<div class="input-group-prepend">
						<span class="input-group-text">File:</span>
					</div>
					<input type="text" class="form-control glowable" id="suggestionFilename" placeholder="Output file name to suggest for selected input file name" />
				</div>
				<div class="input-group mb-3">
					<div class="input-group-prepend">
						<span class="input-group-text">Folder:</span>
					</div>
					<input type="text" class="form-control glowable" id="suggestionFoldername" placeholder="Output folder name to suggest" />
				</div>
				<small>
					<p>
						Note: You can use named capture groups inside your regex and replace substrings in filename and folder with their values. 
						Use 'now:year', 'now:month' and 'now:date' to inject the current date. 
						Use 'now:month-1' to inject the current month minus one.<br /><br />
						Example 1:<br/>
						<code>
							Pattern: 'Scanned document (?&lt;dd&gt;[0-9]{2})\.(?&lt;mm&gt;[0-9]{2})\.(?&lt;yyyy&gt;[0-9]{4})*\.pdf'<br />
							File: 'Letter &lt;mm&gt;.&lt;dd&gt;.pdf'<br />
							Folder: 'Letters &lt;yyyy&gt;'<br />
						</code>
						</p>
						<p>
						Example 2:<br/>
						<code>
							Pattern: 'Invoice from today\.pdf'<br />
							File: 'My invoice &lt;now:year&gt;-&lt;now:month&gt;-&lt;now:date&gt;.pdf'<br />
							Folder: 'Folder XYZ'
						</code>
						</p>
					</p>
				</small>
				
				<a class="btn btn-secondary" href="#" role="button" id="upgradeSuggestion">&uarr;</a>
				
				<a class="btn btn-secondary" href="#" role="button" id="downgradeSuggestion">&darr;</a>
				
				<a class="btn btn-secondary" href="#" role="button" id="removeSuggestion">Löschen</a>
						
				<a class="btn btn-primary" href="#" role="button" id="saveSuggestion">Speichern</a>
			</div>
			
			<input id="importSuggestionsFile" type="file" style="display: none" />
		</form>

		<div class="ml-1">&nbsp;</div>

		<a class="btn btn-secondary" href="#" role="button" id="addSuggestion">New record</a>

		<a class="btn btn-secondary" href="#" role="button" id="exportSuggestions">Export all...</a>
		
		<a class="btn btn-secondary" href="#" role="button" id="importSuggestions">Import all...</a>
	
		<div class="ml-1">&nbsp;</div>
		
		<h5>
			Folder cache
		</h5>
		<a class="btn btn-primary" href="#" role="button" id="renewCache">Rebuild folder cache</a>
		
		<div class="ml-1">&nbsp;</div>
	</main><!-- /.container -->
</body>
</html>