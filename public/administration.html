<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="theme-color" content="#563d7c">
	<title>Archiver</title>
	<link rel="stylesheet" href="css/bootstrap.min.css">
	<link rel="stylesheet" href="css/frontend.css">
	<script src="js/jquery.min.js"></script>
	<script src="js/bootstrap.min.js"></script>
	<script src="js/commons.js"></script>
	<script type="text/javascript">
		$(document).ready(function() {
			var suggestionsListElm = $('#suggestionsList');
			var suggestionNameElm = $('#suggestionName');
			var suggestionExampleElm = $('#suggestionExample');
			var suggestionPatternElm = $('#suggestionPattern');
			var suggestionFilenameElm = $('#suggestionFilename');
			var suggestionFoldernameElm = $('#suggestionFoldername');
			var suggestionIdElm = $('#suggestionId');
			var suggestionOrderElm = $('#suggestionOrder');
			var saveSuggestionElm = $('#saveSuggestion');
			var removeSuggestionElm = $('#removeSuggestion');
			var upgradeSuggestionElm = $('#upgradeSuggestion');
			var downgradeSuggestionElm = $('#downgradeSuggestion');

			// --------------------------- onload functionality
			loadConfig();

			// binds
			$('#renewCache').click(function(evt) {
				$.ajax({
					type: 'POST',
					url: basePathBackend + '/archive/update-directory-cache?depth=25',
					success: function(){
						$('#successmessage').show().delay(4000).slideUp(400, function() {window.location.reload()});
					}
				});
			});
			saveSuggestionElm.click(function(evt) {
			
				// update locally
				var currentSuggestionIndex = suggestions.findIndex(function(suggestion) {return suggestion.id == suggestionIdElm.val()});
				suggestions[currentSuggestionIndex].name = suggestionNameElm.val();
				suggestions[currentSuggestionIndex].pattern = suggestionPatternElm.val();
				suggestions[currentSuggestionIndex].example = suggestionExampleElm.val();
				suggestions[currentSuggestionIndex].filename = suggestionFilenameElm.val();
				suggestions[currentSuggestionIndex].foldername = suggestionFoldernameElm.val();
				
				renderSuggestions();
				
				saveSuggestions();
			});
			removeSuggestionElm.click(function(evt) {
			
				// update locally, then render
				var currentSuggestionIndex = suggestions.findIndex(function(suggestion) {return suggestion.id == suggestionIdElm.val()});
				suggestions.splice(currentSuggestionIndex, 1);
				
				renderSuggestions();
				
				saveSuggestions();
			});
			$('#addSuggestion').click(function(evt) {
				var newSuggestionId = Date.now();
				
				// update locally, then render
				suggestions.push({
					id: newSuggestionId,
					name: "+++ Neuer Eintrag +++",
					pattern: null,
					example: null,
					filename: null,
					foldername: null,
					order: suggestions.length + 1
				});
				
				renderSuggestions();
				
				$('#suggestion-id-' + newSuggestionId).trigger('click');
			});
			$('#upgradeSuggestion').click(function(evt) {
				
				// update locally, then render			
				switchSuggestionOrders(-1);
				
				renderSuggestions();
				
				saveSuggestions();
			});
			$('#downgradeSuggestion').click(function(evt) {
				
				// update locally, then render
				switchSuggestionOrders(1);
				
				renderSuggestions();
				
				saveSuggestions();
			});
			
			// --------------------------- functions
			function switchSuggestionOrders(deltaToSwitchWith) {
				var currentSuggestionIndex = suggestions.findIndex(function(suggestion) {return suggestion.id == suggestionIdElm.val()});
				suggestionIndexB = currentSuggestionIndex + deltaToSwitchWith;

				// switch order of current suggestion and the one above or below
				var bSuggestionOldOrder = suggestions[suggestionIndexB].order;
				suggestions[suggestionIndexB].order = suggestions[currentSuggestionIndex].order;
				suggestions[currentSuggestionIndex].order = bSuggestionOldOrder;
			}
			
			function saveSuggestions() {
				
				// send to backend
				$.ajax({
					type: 'PUT',
					url: basePathBackend + '/config/fileNamePatternsToSuggestions',
					data: JSON.stringify(suggestions),
					success: function(){
						$('#suggestionsForm input').val('');
						$('#successmessage').show().delay(4000).slideUp();
					}
				});
			}
			
			function loadConfig() {
				$.ajax({
					type: 'GET',
					url: basePathBackend + '/config/fileNamePatternsToSuggestions',
					success: function(res){
						suggestions = JSON.parse(res);
						renderSuggestions();
						console.log('config loaded');
					}
				});;
			}
			
			function renderSuggestions() {
				suggestionsListElm.empty();
				removeSuggestionElm.hide();
				upgradeSuggestionElm.hide();
				downgradeSuggestionElm.hide();
				saveSuggestionElm.hide();
				
				$.each(suggestions.sort((a,b) => (a.order > b.order) ? 1 : ((b.order > a.order) ? -1 : 0)), function(index, suggestion) {
					var elm = $('<a href="javascript:void(0)" class="list-group-item list-group-item-action" id="suggestion-id-' + suggestion.id + '" />')
						.append(suggestion.name);
						
					elm.click(function() {
						suggestionsListElm.children().removeClass('active');
						elm.addClass('active');

						suggestionIdElm.data('index', index);
						suggestionIdElm.val(suggestion.id);
						suggestionOrderElm.val(suggestion.order);
						suggestionNameElm.val(suggestion.name);
						suggestionExampleElm.val(suggestion.example);
						suggestionPatternElm.val(suggestion.pattern);
						suggestionFilenameElm.val(suggestion.filename);
						suggestionFoldernameElm.val(suggestion.foldername);
						
						removeSuggestionElm.show();
						if (suggestionIdElm.data('index') < suggestions.length - 1) {
							downgradeSuggestionElm.show();
						} else {
							downgradeSuggestionElm.hide();
						}
						if (suggestionIdElm.data('index') > 0) {
							upgradeSuggestionElm.show();
						} else {
							upgradeSuggestionElm.hide();
						}
						saveSuggestionElm.show();
						
						suggestionNameElm.select();
					});
					
					suggestionsListElm.append(elm);
				});
			}
			
		});
		
	</script>
</head>
<body>
	<nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top">
		<a class="navbar-brand" href="/">Archiver</a>
		
		<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
			<span class="navbar-toggler-icon"></span>
		</button>
		
		<div class="collapse navbar-collapse" id="navbarSupportedContent">
			<ul class="navbar-nav mr-auto">
				<li class="nav-item">
					<a class="nav-link" href="archive.html">Archivieren</a>
				</li>
				<li class="nav-item">
					<a class="nav-link" href="#" id="logout">Abmelden</a>
				</li>
			</ul>
		</div>
	</nav>

	<main role="main" class="container">
		<div class="alert alert-success" role="alert" id="successmessage" style="display:none">
			Konfiguration erfolgreich geändert!
		</div>

		<div class="alert alert-danger" role="alert" id="errormessage" style="display:none">
			Fehler aufgetreten!
		</div>

		<h5>
			Datei- und Ordnervorschläge
		</h5>
		<form id="suggestionsForm">
			<div class="list-group" id="suggestionsList">
			</div>
			
			<div class="ml-1">&nbsp;</div>
			
			<div class="input-group mb-3">
				<input type="hidden" id="suggestionId" />
				<input type="hidden" id="suggestionOrder" />
				<input type="text" class="form-control glowable" id="suggestionName" placeholder="Vorschlagsname" />
			</div>
			<div class="input-group mb-3">
				<input type="text" class="form-control glowable" id="suggestionExample" placeholder="Beispiel-Dateiname" />
			</div>
			<div class="input-group mb-3">
				<input type="text" class="form-control glowable" id="suggestionPattern" placeholder="Regulärer Ausdruck" />
			</div>
			<div class="input-group mb-3">
				<input type="text" class="form-control glowable" id="suggestionFilename" placeholder="Vorzuschlagender Dateiname" />
			</div>
			<div class="input-group mb-3">
				<input type="text" class="form-control glowable" id="suggestionFoldername" placeholder="Vorzuschlagender Ordnername" />
			</div>
		</form>

		<a class="btn btn-secondary" href="#" role="button" id="upgradeSuggestion" style="display: none">&uarr;</a>
		
		<a class="btn btn-secondary" href="#" role="button" id="downgradeSuggestion" style="display: none">&darr;</a>
		
		<a class="btn btn-secondary" href="#" role="button" id="removeSuggestion" style="display: none">Löschen</a>
		
		<a class="btn btn-secondary" href="#" role="button" id="addSuggestion">Neu</a>
		
		<a class="btn btn-primary" href="#" role="button" id="saveSuggestion" style="display: none">Speichern</a>

		<p>
		
		</p>
	
		<h5>
			Verzeichniscache
		</h5>
		<a class="btn btn-primary" href="#" role="button" id="renewCache">Cache erneuern</a>
		
		<div class="ml-1">&nbsp;</div>
	</main><!-- /.container -->
</body>
</html>